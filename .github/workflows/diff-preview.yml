name: Diff Preview
on:
  pull_request:
    branches:
      - main
jobs:
  diff-preview:
    name: Diff Preview
    runs-on: [argocd-diff-runner]
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          path: target-branch
          fetch-depth: 0
      - uses: actions/checkout@v4
        with:
          ref: main
          path: base-branch
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y
          gh --version
      - name: Install Argo CD CLI
        run: |
          curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64
          argocd version --client || true
      - name: Install argocd-diff-preview
        run: |
          curl -LJO https://github.com/dag-andersen/argocd-diff-preview/releases/download/v0.1.17/argocd-diff-preview-Linux-x86_64.tar.gz
          tar -xvf argocd-diff-preview-Linux-x86_64.tar.gz
          sudo mv argocd-diff-preview /usr/local/bin
          argocd-diff-preview --version
      - name: Verify cluster access
        run: |
          echo "Checking cluster access..."
          kubectl get nodes || echo "Cannot list nodes (may need additional permissions)"
          echo "Checking for Argo CD namespace..."
          kubectl get namespace argocd-diff-preview || echo "Namespace argocd-diff-preview does not exist"
          kubectl get namespace argocd || echo "Namespace argocd does not exist"
      - name: Generate Diff
        run: |
          argocd-diff-preview \
            --repo ${{ github.repository }} \
            --base-branch main \
            --target-branch refs/pull/${{ github.event.number }}/merge \
            --argocd-namespace argocd-diff-preview \
            --create-cluster=false \
            --debug
      - name: Check output
        if: always()
        run: |
          echo "Checking for output files..."
          ls -la output/ || echo "Output directory does not exist"
          if [ -f output/diff.md ]; then
            echo "diff.md found. Content preview:"
            head -50 output/diff.md
          else
            echo "diff.md not found!"
          fi
      - name: Comment preview
        if: hashFiles('output/diff.md') != ''
        run: |
          gh pr comment ${{ github.event.number }} --repo ${{ github.repository }} --body-file output/diff.md --edit-last || \
          gh pr comment ${{ github.event.number }} --repo ${{ github.repository }} --body-file output/diff.md
        env:
          GITHUB_TOKEN: ${{ secrets.ARGOCD_GITHUB_TOKEN }}
